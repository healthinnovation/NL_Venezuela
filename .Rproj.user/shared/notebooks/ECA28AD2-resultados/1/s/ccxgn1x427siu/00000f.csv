"0",""
"0","#install.packages(""ggExtra"")"
"0","library(ggExtra)"
"0","library(pals)"
"0",""
"0",""
"0","d_v_yy <-   db.vec.shp %>%"
"0","            ungroup() %>%"
"0","            group_by(Year, ADM2_ES, ADM3_ES) %>%"
"0","            summarise(PV = sum(PV, na.rm = T),"
"0","                      PF = sum(PF, na.rm = T),"
"0","                      pop = sum(pop, na.rm = T),"
"0","                      viirs = mean(viirs, na.rm = T),"
"0","                      r.pv = PV/pop,"
"0","                      r.pf = PF/pop,"
"0","                      mei = mean(mei)) %>%"
"0","            ungroup()"
"0",""
"0",""
"0","  "
"0","smooth.plot <-    d_v_yy                                                 %>%"
"0","                    mutate(r.pv=r.pv*1000,"
"0","                           r.pf=r.pf*1000)                                   %>%"
"0","                    dplyr::select(r.pv, r.pf,ADM2_ES, viirs)                 %>%"
"0","                    gather(type, rate, r.pv:r.pf)                            %>%"
"0","                    bi_plot(trans_x = F,limits_y=c(0,100))"
"0",""
"0","  "
"0","#bs"
"0","var.data         <- d_v_yy %>%"
"0","              ungroup() %>%"
"0","              group_by(ADM2_ES, ADM3_ES) %>%"
"0","              summarise(viirs_init = first(viirs)+1, "
"0","                        viirs_last = last(viirs)+1,"
"0","                        pv_init = first(r.pv)+1, pv_last = last(r.pv)+1,"
"0","                        pf_init = first(r.pf)+1, pf_last = last(r.pf)+1,"
"0","                        mei_init = first(mei)+1, mei_last = last(mei)+1) %>%"
"0","              ungroup() %>%"
"0","              mutate(viirs_last = ifelse(viirs_last<0,0,viirs_last),"
"0","                     delta_viirs = 100*((viirs_last/viirs_init)-1),"
"0","                     delta_viirs2 = 100*((viirs_init/viirs_last)-1),"
"0","                     delta_pv = 100*((pv_init/pv_last)-1),"
"0","                     delta_pv2 = 100*((pv_last/pv_init)-1),"
"0","                     delta_pf = 100*((pf_init/pf_last)-1),"
"0","                     delta_pf2 = 100*((pf_last/pf_init)-1),"
"0","                     delta_mei = 100*((mei_init/mei_last)-1),"
"0","                     cod = paste0(ADM2_ES, ""-"", ADM3_ES),"
"0","                     id = as.numeric(as.factor(cod))) %>% "
"0","             # censura"
"0","             mutate(delta_viirs = ifelse(delta_viirs>100,100,delta_viirs),"
"0","                    delta_viirs = ifelse(delta_viirs<(100*-1),-100,delta_viirs)"
"0","                    )"
"0",""
"0",""
"0","#area.bs"
"0","vene.vars <- vene.shp %>%"
"0","  inner_join(var.data, by=c(""municipio""=""ADM2_ES"", ""parroquia""=""ADM3_ES"")) %>%"
"0","  mutate(delta_viirs_c = ntile(delta_viirs, 5),"
"0","         delta_pv_c = ntile(delta_pv, 5),"
"0","         delta_pf_c = ntile(delta_pf, 5),"
"0","         delta_mei_c = ntile(delta_mei, 5))"
"0",""
"0",""
"0",""
"0","  aa <- vene.vars            %>%"
"0","        mutate(x = 1)              %>%"
"0","        group_by(x)                %>%"
"0","        summarise(x = mean(x))"
"0",""
"0","  limit <- c(-101, 101)"
"0","  "
"0",""
"0","  "
"0","vars.plot <- vene.vars %>%"
"0","              select(delta_viirs, delta_pv2, delta_pf2) %>%"
"0","              gather(key = var, value = val, delta_viirs:delta_pf2) %>%"
"0","              ggplot() +"
"0","              geom_sf(aes(fill=val), size = 0.1) + "
"0","               geom_sf(data = aa, fill = NA, color = ""black"", size = 100 ) +"
"0","              scale_fill_gradientn(colours=ocean.curl(200), guide = ""colourbar"","
"0","                                   limit = limit) +"
"0","              theme_void() +"
"0","              facet_wrap(.~var, nrow = 1,"
"0","                         labeller = as_labeller(c(`delta_pf2` = ""P. falciparum"", "
"0","                                                  `delta_pv2` = ""P. vivax"", "
"0","                                                  `delta_viirs` = ""VIIRS""))"
"0","                         ) +"
"0","              labs(fill = ""% variation \n(ref: 2012)"") +"
"0","              theme(legend.position = ""bottom"")"
"0",""
"0","library(cowplot)"
"0","full.plot <- plot_grid(smooth.plot, vars.plot, ncol = 1, labels = c(""A)"", ""B)""))"
"0","full.plot"
